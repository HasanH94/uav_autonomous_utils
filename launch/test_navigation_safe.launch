<?xml version="1.0"?>
<launch>

    <!-- Safe Testing Launch File - Start components one by one -->
    
    <arg name="test_mode" default="full"/>  <!-- basic, with_state_machine, full -->
    
    <!-- Stage 1: Basic Components (always start these) -->
    <group if="$(eval arg('test_mode') in ['basic', 'with_state_machine', 'full'])">
        
        <!-- Navigation Mode Manager -->
        <node pkg="uav_autonomous_utils" type="navigation_mode_manager.py"
              name="navigation_mode_manager" output="screen">
            <param name="visual_activation_distance" value="20.0"/>
            <remap from="/aruco_offset_pose" to="/move_base_visual"/>
        </node>
        
        <!-- Trajectory-Aware PID (without APF first) -->
        <node pkg="uav_autonomous_utils" type="trajectory_aware_pid_controller.py" 
              name="trajectory_aware_pid" output="screen">
            <param name="enable_trajectory_mode" value="true"/>
            <param name="priority_mode" value="auto"/>
            <rosparam param="kp_position">[0.8, 0.8, 0.6, 0.8]</rosparam>
            <rosparam param="ki_position">[0.05, 0.05, 0.05, 0.01]</rosparam>
            <rosparam param="kd_position">[0.07, 0.07, 0.04, 0.05]</rosparam>

            <!-- Gains for Trajectory Tracking Mode (PD Controller) -->
            <rosparam param="kp_trajectory">[1.2, 1.2, 0.8, 1.0]</rosparam>
            <rosparam param="kd_trajectory">[0.3, 0.3, 0.2, 0.2]</rosparam>
            <rosparam param="ki_trajectory">[0.0, 0.0, 0.0, 0.0]</rosparam>

            <!-- <remap from="/uav/attractive_velocity" to="/mavros/setpoint_velocity/cmd_vel"/> -->
            
            <!-- Yaw Parameters -->
            <param name="yaw_distance_threshold" value="60.0"/>
            <param name="yaw_injection_distance" value="1.5"/>
            <param name="max_yaw_rate" value="1.5"/>
            <param name="control_frequency" value="20.0"/>
            <param name="search_yaw_rate" value="0.5"/>
            
            <!-- Output to test topic first, not directly to mavros -->
            <!-- <remap from="/uav/attractive_velocity" to="/mavros/setpoint_velocity/cmd_vel"/> -->
        </node>
        
    </group>
    
    <!-- Stage 2: Add State Machine -->
    <group if="$(eval arg('test_mode') in ['with_state_machine', 'full'])">
        
        <node pkg="uav_autonomous_utils" type="enhanced_drone_state_machine.py" 
              name="drone_state_machine" output="screen">
            <rosparam param="goal_points">[[10.0, -5.0, 3.0], [10.0, -10.0, 3.0]]</rosparam>
            <rosparam param="home_position">[0.0, 0.0, 2.0]</rosparam>
            <param name="aruco_detection_window_size" value="30"/>
            <param name="aruco_detection_threshold" value="0.7"/>
            <param name="gps_goal_tolerance" value="3.0"/>
            <param name="visual_pose_tolerance" value="0.3"/>
        </node>
        
    </group>
    
    <!-- Stage 3: Full System with APF -->
    <group if="$(eval arg('test_mode') == 'full')">
        
        <!-- APF Obstacle Avoidance -->
        <node pkg="uav_autonomous_utils" type="apf_3d_node.py" 
              name="apf_3d_node" output="screen">
            <param name="r" value="6.5" />
            <param name="eta_xy" value="0.0004" />   <!-- repulsion_gain for XY -->
            <param name="eta_z" value="0.00002" />   <!-- repulsion_gain for Z -->
            <param name="eps" value="0.1" />  <!-- minimum_distance -->
            <param name="max_rep_norm" value="100.0" />
            <param name="max_out_norm" value="1.5" />
            <param name="alpha" value="0.85" /> <!-- exp moving average for the repulsion -->
            <param name="ignore_z" value="false" />
            <param name="max_points" value="10000" />
            <param name="attractive_topic" value="/uav/attractive_velocity" />
            <param name="pointcloud_topic" value="/iris/camera/depth/points" />
            <param name="output_topic" value="/mavros/setpoint_velocity/cmd_vel" />
            <!-- Remap for testing -->
            <!-- <remap from="/uav/attractive_velocity" to="/test/attractive_velocity"/> -->
            <!-- <remap from="/iris/camera/depth/points" to="/test/pointcloud"/> -->
            <!-- <remap from="/mavros/setpoint_velocity/cmd_vel" to="/test/final_velocity"/> -->
        </node>
        
    </group>
    
    <!-- Test Monitoring Tools -->
    <!-- <node pkg="rqt_graph" type="rqt_graph" name="rqt_graph"/> -->
    
</launch>