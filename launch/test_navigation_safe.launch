<?xml version="1.0"?>
<launch>

    <!-- Safe Testing Launch File - Start components one by one -->
    
    <arg name="test_mode" default="basic"/>  <!-- basic, with_state_machine, full -->
    
    <!-- Stage 1: Basic Components (always start these) -->
    <group if="$(eval arg('test_mode') in ['basic', 'with_state_machine', 'full'])">
        
        <!-- Navigation Mode Manager - DISABLED: Functionality merged into enhanced_drone_state_machine.py -->
        <!-- <node pkg="uav_autonomous_utils" type="navigation_mode_manager.py"
              name="navigation_mode_manager" output="screen">
            <param name="visual_activation_distance" value="20.0"/>
            <remap from="/aruco_offset_pose" to="/move_base_visual"/>
        </node> -->
        
        <!-- Trajectory-Aware PID (without APF first) -->
        <node pkg="uav_autonomous_utils" type="trajectory_aware_pid_controller.py" 
              name="trajectory_aware_pid" output="screen">
            <param name="enable_trajectory_mode" value="true"/>
            <param name="priority_mode" value="auto"/>
            <!-- <rosparam param="kp_position">[0.5, 0.5, 0.5, 0.8]</rosparam>
            <rosparam param="ki_position">[0.02, 0.02, 0.02, 0.01]</rosparam>
            <rosparam param="kd_position">[0.07, 0.07, 0.04, 0.05]</rosparam> -->

            <rosparam param="kp_position">[0.8, 0.8, 0.8, 0.8]</rosparam>
            <rosparam param="ki_position">[0.05, 0.05, 0.05, 0.01]</rosparam>
            <rosparam param="kd_position">[0.4, 0.4, 0.4, 0.05]</rosparam>

            <!-- Gains for Trajectory Tracking Mode (PD Controller) -->
            <rosparam param="kp_trajectory">[1.2, 1.2, 0.8, 1.0]</rosparam>
            <rosparam param="kd_trajectory">[0.3, 0.3, 0.2, 0.2]</rosparam>
            <rosparam param="ki_trajectory">[0.0, 0.0, 0.0, 0.0]</rosparam>

            <!-- <remap from="/uav/attractive_velocity" to="/mavros/setpoint_velocity/cmd_vel"/> -->
            
            <!-- Yaw Parameters -->
            <param name="yaw_distance_threshold" value="60.0"/>
            <param name="yaw_injection_distance" value="1.5"/>
            <param name="max_yaw_rate" value="1.5"/>
            <param name="control_frequency" value="100.0"/>
            <param name="search_yaw_rate" value="0.5"/>
            <param name="max_velocity" value="2.0"/>
            
            <!-- Output to test topic first, not directly to mavros -->
            <!-- <remap from="/uav/attractive_velocity" to="/mavros/setpoint_velocity/cmd_vel"/> -->
        </node>
      
        <!-- Enhanced Drone State Machine -->
        <node pkg="uav_autonomous_utils" type="enhanced_drone_state_machine.py" name="drone_state_machine" output="screen">
            <rosparam param="goal_points">[[10.0, -3.0, 3.0], [10.0, -10.0, 3.0]]</rosparam>
            <rosparam param="home_position">[0.0, 0.0, 2.0]</rosparam>
            <param name="aruco_detection_window_size" value="20"/>
            <param name="aruco_detection_threshold" value="0.2"/>
            <param name="gps_goal_tolerance" value="3.0"/>
            <param name="visual_pose_tolerance" value="0.3"/>
        </node>


        <!-- Dynamics-Aware 3D Velocity-Obstacle Safety Filter -->
        <node pkg="uav_autonomous_utils" type="dynamics_aware_vo_filter.py" 
              name="dynamics_aware_vo_filter_3d" output="screen">
            <!-- Topics -->
            <param name="input_twist_topic" value="/uav/attractive_velocity" />
            <param name="output_twist_topic" value="/mavros/setpoint_velocity/cmd_vel" />
            <param name="cloud_topic" value="/iris/camera/depth/points" />
            <param name="odom_topic" value="/mavros/local_position/odom" />
            <param name="world_frame" value="odom" />
            
            <!-- VO / Safety Parameters -->
            <param name="time_horizon" value="3.0" />         <!-- [s] react only if collision < Ï„ -->
            <param name="safety_margin" value="1.0" />       <!-- [m] -->
            <param name="point_obstacle_radius" value="0.05" /> <!-- [m] inflate a point -->
            <param name="max_obstacles" value="16" />
            <param name="min_range" value="0.30" />           <!-- [m] ignore too-close returns (self-body) -->
            <param name="max_range" value="12.0" />           <!-- [m] -->
            <param name="max_rot_iter" value="3" />           <!-- VO resolve iterations -->
            <param name="boundary_eps" value="0.001" />
            <param name="voxel_size" value="0.20" />          <!-- [m] for light downsampling -->
            
            <!-- Dynamics-aware closeness (body-aligned weights) -->
            <param name="w_body_x" value="2.0" />             <!-- Weight for forward/backward in drone frame -->
            <param name="w_body_y" value="1.0" />             <!-- Weight for left/right in drone frame -->
            <param name="w_body_z" value="4.0" />             <!-- Weight for up/down in drone frame (higher = less preferred) -->
            
            <!-- Speed limits (consistent with PX4 style limits) -->
            <param name="v_xy_max" value="3.0" />             <!-- [m/s] max horizontal speed -->
            <param name="v_z_up_max" value="1.5" />           <!-- [m/s] max upward speed -->
            <param name="v_z_dn_max" value="1.0" />           <!-- [m/s] max downward speed magnitude -->
        </node>
       
        
    </group>
    
    <!-- Stage 2: Add State Machine -->
    <!-- <group if="$(eval arg('test_mode') in ['with_state_machine', 'full'])">
        
    </group> -->
    
    <!-- Stage 3: Full System with APF -->
    <group if="$(eval arg('test_mode') == 'full')">
        
        <!-- APF Obstacle Avoidance -->
        <node pkg="uav_autonomous_utils" type="apf_3d_node.py" 
              name="apf_3d_node" output="screen">
            <param name="r" value="6.5" />
            <param name="eta_xy" value="0.0004" />   <!-- repulsion_gain for XY -->
            <param name="eta_z" value="0.00002" />   <!-- repulsion_gain for Z -->
            <param name="eps" value="0.1" />  <!-- minimum_distance -->
            <param name="max_rep_norm" value="100.0" />
            <param name="max_out_norm" value="1.5" />
            <param name="alpha" value="0.85" /> <!-- exp moving average for the repulsion -->
            <param name="ignore_z" value="false" />
            <param name="max_points" value="10000" />
            <param name="attractive_topic" value="/uav/attractive_velocity" />
            <param name="pointcloud_topic" value="/iris/camera/depth/points" />
            <param name="output_topic" value="/mavros/setpoint_velocity/cmd_vel" />
            <!-- Remap for testing -->
            <!-- <remap from="/uav/attractive_velocity" to="/test/attractive_velocity"/> -->
            <!-- <remap from="/iris/camera/depth/points" to="/test/pointcloud"/> -->
            <!-- <remap from="/mavros/setpoint_velocity/cmd_vel" to="/test/final_velocity"/> -->
        </node>
        
    </group>
    
    <!-- Test Monitoring Tools -->
    <!-- <node pkg="rqt_graph" type="rqt_graph" name="rqt_graph"/> -->
    
</launch>